
import streamlit as st
import qrcode
import pandas as pd
import datetime
import os
from fpdf import FPDF
from PIL import Image
from io import BytesIO

# --- 1. DATOS DE TU EMPRESA (C√°mbialos aqu√≠) ---
EMPRESA = {
    "nombre": "CONTROL DE PLAGAS PROFESIONAL",
    "cuit": "30-XXXXXXXX-X",
    "direccion": "Tu Calle 123, Ciudad",
    "permisos": "Hab. Municipal N¬∫ 1234 - Sanidad Ambiental",
}

# --- 2. FUNCI√ìN PARA GENERAR EL PDF ---
def crear_pdf(datos, qr_img):
    pdf = FPDF()
    pdf.add_page()
    pdf.rect(5, 5, 200, 287) # Recuadro del borde
    
    # Encabezado con datos de la empresa
    pdf.set_font("Arial", 'B', 16)
    pdf.cell(0, 10, EMPRESA["nombre"], ln=True, align='C')
    pdf.set_font("Arial", '', 10)
    pdf.cell(0, 5, f"CUIT: {EMPRESA['cuit']} | {EMPRESA['direccion']}", ln=True, align='C')
    pdf.cell(0, 5, f"Permisos: {EMPRESA['permisos']}", ln=True, align='C')
    pdf.ln(10)
    
    # T√≠tulo del Certificado
    pdf.set_font("Arial", 'B', 22)
    pdf.set_text_color(40, 40, 40)
    pdf.cell(0, 15, f"CERTIFICADO DE {datos['Servicio'].upper()}", ln=True, align='C')
    pdf.ln(10)
    
    # Cuerpo del mensaje
    pdf.set_font("Arial", '', 12)
    pdf.set_text_color(0, 0, 0)
    texto = f"Por la presente se certifica que se ha realizado el servicio de {datos['Servicio']} en el establecimiento de {datos['Cliente']}, ubicado en {datos['Direcci√≥n']}."
    pdf.multi_cell(0, 10, texto)
    pdf.ln(10)
    
    # Detalles T√©cnicos
    pdf.set_font("Arial", 'B', 12)
    pdf.cell(0, 10, "Detalles del Servicio:", ln=True)
    pdf.set_font("Arial", '', 11)
    pdf.cell(0, 8, f"‚Ä¢ Fecha de Aplicaci√≥n: {datos['Fecha']}", ln=True)
    pdf.cell(0, 8, f"‚Ä¢ Productos utilizados: {datos['Productos']}", ln=True)
    pdf.cell(0, 8, f"‚Ä¢ Pr√≥ximo Vencimiento: {datos['Vencimiento']}", ln=True)
    
    # Insertar QR de validaci√≥n
    qr_path = "temp_qr.png"
    qr_img.save(qr_path)
    pdf.image(qr_path, x=150, y=230, w=40)
    
    pdf.set_font("Arial", 'I', 8)
    pdf.set_y(260)
    pdf.cell(0, 10, "Este documento es una constancia digital de servicio.", align='C')
    
    return pdf.output(dest='S').encode('latin-1')

# --- 3. INTERFAZ DE LA APLICACI√ìN (Lo que ves en el celular) ---
st.set_page_config(page_title="Generador de Certificados", page_icon="üõ°Ô∏è")

st.title("üõ°Ô∏è Certificados de Fumigaci√≥n")
st.write("Completa los datos para generar el PDF al instante.")

with st.form("formulario_servicio"):
    col1, col2 = st.columns(2)
    with col1:
        cliente = st.text_input("Nombre del Cliente / Local")
        direccion = st.text_input("Direcci√≥n del Servicio")
    with col2:
        servicio = st.selectbox("Tipo de Servicio", ["Desinsectaci√≥n", "Desratizaci√≥n", "Desinfecci√≥n"])
        fecha_hoy = datetime.date.today()
    
    productos = st.multiselect(
        "Productos Utilizados", 
        ["Deltametrina", "Cipermetrina", "Bromadiolona (Bloques)", "Fipronil (Gel)", "Amonio Cuaternario"]
    )
    
    comentarios = st.text_area("Observaciones adicionales")
    
    boton_generar = st.form_submit_button("üöÄ Generar y Descargar PDF")

if boton_generar:
    if not cliente or not direccion:
        st.error("Por favor, completa el nombre del cliente y la direcci√≥n.")
    else:
        # C√°lculos de fecha
        vencimiento = fecha_hoy + datetime.timedelta(days=30)
        
        datos_finales = {
            "Fecha": fecha_hoy.strftime("%d/%m/%Y"),
            "Cliente": cliente,
            "Direcci√≥n": direccion,
            "Servicio": servicio,
            "Productos": ", ".join(productos),
            "Vencimiento": vencimiento.strftime("%d/%m/%Y")
        }
        
        # Crear QR din√°mico (Verde para Desratizaci√≥n, Azul para el resto)
        color_qr = "green" if servicio == "Desratizaci√≥n" else "darkblue"
        qr = qrcode.QRCode(box_size=10, border=2)
        qr.add_data(f"Servicio: {servicio}\nCliente: {cliente}\nFecha: {datos_finales['Fecha']}")
        qr.make(fit=True)
        img_qr = qr.make_image(fill_color=color_qr, back_color="white")
        
        # Generar el archivo PDF
        pdf_output = crear_pdf(datos_finales, img_qr)
        
        st.success(f"‚úÖ Certificado para {cliente} generado con √©xito.")
        
        # Bot√≥n para descargar
        st.download_button(
            label="üì• Descargar Certificado PDF",
            data=pdf_output,
            file_name=f"Certificado_{cliente}_{fecha_hoy}.pdf",
            mime="application/pdf"
        )
